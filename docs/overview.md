# Огляд проєкту Referendum

Це соціальна платформа для проведення онлайн-опитувань і референдумів. Проєкт побудований на шаблоні **Yii 2 Advanced**, що забезпечує поділ на фронтенд, бекенд та спільні компоненти.

## Основні можливості

- створення та редагування опитувань;
- голосування за варіанти відповідей;
- коментування та оцінка коментарів;
- побудова графіків результатів;
- поширення опитувань у соцмережах та копіювання прямого посилання.

## Структура

- **frontend/** – публічна частина сайту з модулями `poll`, `user` та `ajax`;
- **backend/** – адміністративна панель;
- **common/** – спільні моделі та налаштування.

## Розробницьке середовище

Для швидкого старту використовується `docker-compose`:

```bash
docker-compose up -d
```

Після запуску фронтенд доступний на [http://localhost:20080](http://localhost:20080), а бекенд – на [http://localhost:21080](http://localhost:21080).

## Встановлення без Docker

```bash
composer install
php init
cp .env.example .env
```

Після копіювання файлу `.env` заповніть у ньому змінні `DB_DSN`, `DB_USERNAME`, `DB_PASSWORD` та за потреби `DB_TEST_DSN`.

## Версія PHP

Сайт наразі працює на версії **PHP 7.3**. Рекомендується поступово перейти на новішу гілку PHP (наприклад, 8.2 або 8.4) для покращення продуктивності та безпеки. Перед оновленням варто протестувати сумісність усього коду.

## Тестування

Фреймворк PHPUnit налаштований у файлі `phpunit.xml`. Базові прикладові тести містяться в каталозі `tests/`.

```bash
vendor/bin/phpunit
```

Документація буде доповнюватися у міру розвитку проєкту.

## Канонічні піддомени

Сторінки опитувань автоматично перенаправляються на піддомен, що відповідає мові опитування. Наприклад, звернення до
`https://ua.referendum.social/poll/573` або `https://referendum.social/poll/573` буде переадресовано на
`https://en.referendum.social/poll/573`, якщо опитування створене англійською. Для коректної індексації додається тег
`<link rel="canonical">` з посиланням на канонічну адресу.

## Мікророзмітка та часові пояси

Дата публікації опитувань у мікророзмітці `DiscussionForumPosting` тепер містить часовий пояс **America/New_York**. Часовий пояс задається в атрибуті `content` і не відображається користувачам на сторінці.
Дата публікації коментарів переноситься у окремий тег `<meta itemprop="datePublished">` всередині кожного блоку коментаря; видимий текст дати лишається без змін.
Мета‑теги `mainEntityOfPage` та `url` отримують абсолютну адресу сторінки через `Yii::$app->request->absoluteUrl`, що гарантує коректні посилання незалежно від домену.
У `<head>` сторінки додається мета‑тег `og:image`, що генерується на основі `Yii::$app->request->hostInfo` і вказує на файл `/img/kvadrat.png` поточного піддомену.

## Генерація Sitemap

Для побудови XML‑карт сайту використовується консольна команда:

```bash
php yii sitemap/index
```

До sitemap додаються всі існуючі опитування незалежно від статусу. Після видалення опитування через адмінку воно автоматично припиняє потрапляти до карти сайту.

## Текстовий опис тегів

На сторінках тегів відображається автоматично сформований блок із короткою статистикою: дата створення тегу, кількість пов'язаних опитувань, найпопулярніше опитування (за кількістю голосів), опитування з найбільшим рейтингом та дата останнього опитування. Назви опитувань містять посилання на відповідні сторінки.

В англомовній локалізації для кращої індексації використовуються ключові фрази на кшталт "Opinions {tag} polling" та "polls {tag} update".

Для російської та норвезької версій додано оновлені переклади цього опису, а формат дат автоматично підлаштовується під вибрану мову.

Опис англійською також очищено від залишків українського тексту, тож усі локалі відображають повні переклади без змішування мов.

## Виправлення JavaScript

Скрипти сторінки опитування тепер використовують повне ім'я `jQuery` замість скорочення `$`. Це усуває помилку `Uncaught ReferenceError: $ is not defined`, що з'являлась у браузері під час роботи з формою додавання відповіді та фільтрами.


Код JavaScript реєструється через `View::registerJs`, тому виконується лише після завантаження бібліотеки jQuery. Завдяки цьому усувається помилка `ReferenceError: jQuery is not defined`.

## Фільтрація голосів

На сторінці опитування реалізовано показ вибірки голосів за статтю, віком, країною та статусом реєстрації користувачів. Фільтр «Регіон» тимчасово вимкнено, але лишається закоментованим у коді для можливого відновлення.
Під час вибору фільтрів результати графіка перераховуються на основі реальних голосів користувачів, що відповідають
заданим параметрам. Гостьові голоси не враховуються при застосуванні фільтрів, окрім випадку вибору лише незареєстрованих.

Після останнього оновлення виправлено врахування гостьових голосів: фільтри за статтю, віком та країною знову працюють коректно разом із фільтром реєстрації.

Додатково запит до таблиці `option_vote` відкидає записи з порожнім `user_id`, тож гостьові голоси не змішуються із зареєстрованими. Гостьові голоси враховуються лише тоді, коли не задано жодного іншого фільтра.

Додатково виправлено підрахунок загальної кількості голосів, тож відсотки відповідають реальним даним, а фільтр «Реєстрація» працює одночасно з іншими параметрами.

## Усунення залишків Yii 1

У шаблоні перегляду опитування (`frontend/views/poll/view.php`) видалено застарілі виклики `Yii::app()`. Тепер використовується синтаксис `Yii::$app` та помічник `Url::to()`, що відповідає стандартам Yii 2.
У формах реєстрації та опитувань замінено `CCaptchaAction` на `yii\captcha\CaptchaAction`, а оновлення зображення виконується через параметр `refresh=1`, тому кожен клік показує новий код.



## Стилі

Більшість таблиць стилів підключаються з атрибутом `rel="preload"` і після завантаження перетворюються на звичайні `stylesheet`. Це зменшує час відображення. Водночас критичний файл `bootstrap.min.css` завантажується стандартно через `rel="stylesheet"`, щоб уникнути зміщення макета (CLS). Для користувачів без увімкненого JavaScript у шаблоні є блок `<noscript>`, який підключає всі стилі звичайним способом.


## Валідація HTML

- Атрибути `width` та `height` у логотипі хедера вказані без `px`, що відповідає стандарту HTML і проходить валідацію.
